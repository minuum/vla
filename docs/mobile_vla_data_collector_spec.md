# Mobile VLA Data Collector 기능 명세서

## 1. 개요
`mobile_vla_data_collector`는 모바일 로봇(Mobile VLA)의 주행 데이터를 수집하기 위한 ROS2 노드입니다. 사용자는 키보드를 통해 로봇을 제어하거나 사전에 정의된 가이드를 따라 자동으로 주행하며 이미지와 액션 데이터를 수집할 수 있습니다.

## 2. 주요 기능

### 2.1 제어 모드
- **수동 제어**: WASD 키를 사용하여 로봇을 직접 제어합니다.
- **자동 측정 (Auto Measurement)**: 사전에 정의된 가이드(키 입력 시퀀스)를 따라 로봇이 자동으로 주행하며 데이터를 수집합니다.
- **가이드 편집**: 사용자가 직접 가이드를 입력하고 수정할 수 있습니다.

### 2.2 가이드 시스템
- **데이터셋 모드 (Dataset Mode)**: 데이터셋에서 가장 많이 사용된 패턴을 자동으로 추출하여 가이드로 사용합니다. (기본값)
- **수동 모드 (Manual Mode)**: 사용자가 직접 편집하여 `core_patterns.json`에 저장된 가이드를 사용합니다.
- **자동 모드 전환**: 사용자가 가이드를 편집하여 저장하면, 시스템은 자동으로 **수동 모드**로 전환되어 편집된 가이드가 즉시 적용됩니다.

### 2.3 데이터 수집
- **포맷**: HDF5 (.h5) 형식으로 저장됩니다.
- **내용**:
    - 이미지: 720x1280 RGB 이미지
    - 액션: 선형 속도(x, y), 각속도(z)
    - 메타데이터: 시나리오, 패턴, 거리, 시간대 등
- **구조**: 18프레임 고정 (RoboVLMs 학습 최적화: window=8 + pred_next=10)

## 3. 키 매핑 (Key Mappings)

| 키 | 기능 | 설명 |
|---|---|---|
| **W/A/S/D** | 이동 | 전후좌우 이동 |
| **Q/E/Z/C** | 대각선 이동 | 대각선 방향 이동 |
| **R/T** | 회전 | 좌우 회전 |
| **SPACE** | 정지 | 로봇 정지 |
| **N** | 새 에피소드 | 시나리오 선택 및 새 에피소드 시작 |
| **M** | 에피소드 종료 | 현재 수집 중인 에피소드 저장 및 종료 |
| **H** | 가이드 편집 | 현재 선택된 시나리오/패턴/거리에 대한 가이드 편집 |
| **A** | 자동 측정 | 현재 설정된 가이드로 자동 측정 시작 |
| **S** | 설정 | 가이드 모드(데이터셋/수동) 변경 |
| **X** | 리셋/취소 | 초기 화면으로 돌아가거나 현재 작업 취소 |

## 4. 워크플로우

### 4.1 기본 수집 절차
1. `N` 키를 눌러 시나리오 선택 (1~4)
2. 패턴 선택 (C: Core, V: Variant)
3. 거리 선택 (J: Close, K: Medium, L: Far)
4. 반복 횟수 입력 (Enter: 1회)
5. 자동 측정 시작 (`A` 키 또는 가이드 편집 후 자동 시작)

### 4.2 가이드 편집 및 자동 실행
1. 시나리오/패턴/거리 선택 후 `H` 키 입력
2. 원하는 키 시퀀스 입력 (예: `W W W A`)
3. `Enter` 키로 저장
4. **자동 실행**: 저장 즉시 수동 모드로 전환되며, 입력한 가이드대로 로봇이 주행을 시작합니다.

## 5. 파일 구조
- **데이터 저장소**: `/home/soda/vla/ROS_action/mobile_vla_dataset/`
- **설정 파일**:
    - `core_patterns.json`: 수동 모드 가이드 저장
    - `settings.json`: 시스템 설정 (가이드 모드 등)
    - `scenario_progress.json`: 시나리오별 수집 진행률

## 6. 주의사항
- **안전**: 자동 측정 중에는 로봇이 자동으로 움직이므로 주변 장애물에 주의해야 합니다.
- **중단**: 비상 시 `SPACE` 바 또는 `A` 키를 다시 눌러 자동 측정을 즉시 중단할 수 있습니다.
