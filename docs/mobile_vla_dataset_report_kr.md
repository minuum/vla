# Mobile VLA Dataset 수집 보고서

**작성일**: 2025년 12월 4일  
**버전**: v1.0  
**데이터셋 경로**: `ROS_action/mobile_vla_dataset`  
**작성자**: VLA Data Collection Team

---

## 📋 목차

1. [개요](#1-개요)
2. [데이터셋 명세](#2-데이터셋-명세)
3. [수집 프로세스](#3-수집-프로세스)
4. [수집 과정에서 발생한 이슈 및 해결 방법](#4-수집-과정에서-발생한-이슈-및-해결-방법)
5. [데이터 품질 관리](#5-데이터-품질-관리)
6. [통계 및 분석](#6-통계-및-분석)
7. [향후 계획](#7-향후-계획)
8. [부록](#8-부록)

---

## 1. 개요

### 1.1 프로젝트 목적
Mobile VLA (Vision-Language-Action) 모델 학습을 위한 로봇 주행 데이터셋 구축. 
실내 환경에서 옴니휠 로봇이 장애물(박스)을 회피하며 목표 지점까지 이동하는 에피소드를 수집.

### 1.2 데이터셋 현황 요약
- **총 수집 파일 수**: 500개 (목표: 1,000개, 진행률: 50%)
- **데이터셋 크기**: 13GB
- **수집 기간**: 2025년 12월 3일 ~ 2025년 12월 4일 (약 33시간)
- **평균 수집 속도**: 15.3 에피소드/시간
- **Legacy 데이터**: 509개 (품질 기준 미달로 분리 보관)

### 1.3 시나리오 구성
| 시나리오 ID | 설명 | 수집 완료 | 목표 | 진행률 |
|------------|------|----------|------|--------|
| `1box_left` | 왼쪽 경로 회피 | 250개 | 250개 | 100% ✅ |
| `1box_right` | 오른쪽 경로 회피 | 250개 | 250개 | 100% ✅ |
| `2box_*` | 복잡 경로 (미수집) | 0개 | 500개 | 0% |

---

## 2. 데이터셋 명세

### 2.1 파일 구조
```
ROS_action/mobile_vla_dataset/
├── episode_YYYYMMDD_HHMMSS_<scenario>_<difficulty>.h5  # 에피소드 데이터
├── core_patterns.json                                   # 각 시나리오별 표준 패턴
├── scenario_progress.json                               # 시나리오별 진행 상황
├── time_period_stats.json                               # 시간대별 수집 통계
└── settings.json                                        # 데이터 수집 설정
```

### 2.2 HDF5 파일 스키마
각 `.h5` 파일은 다음 구조를 가집니다:

```python
episode_*.h5
├── actions: np.array (shape: [18, 3], dtype: float32)
│   # [linear_x, linear_y, angular_z] 속도 명령
│   # Frame 0: 시작 정지 상태
│   # Frame 1-17: 실제 동작 시퀀스
│
├── images: np.array (shape: [18, H, W, 3], dtype: uint8)
│   # 각 프레임별 RGB 이미지
│
├── language_instruction: string
│   # 자연어 명령 (예: "1box_left 경로로 이동")
│
└── action_event_types: np.array (shape: [18], dtype: int)
    # 각 프레임의 이벤트 타입 (0: 정지, 1: 이동 등)
```

### 2.3 동작 시퀀스 인코딩
로봇의 동작은 키보드 키 매핑으로 표현됩니다:

| 키 | Linear X | Linear Y | Angular Z | 방향 |
|----|----------|----------|-----------|------|
| **W** | 1.15 | 0.0 | 0.0 | 전진 |
| **A** | 0.0 | 1.15 | 0.0 | 좌측 이동 |
| **S** | -1.15 | 0.0 | 0.0 | 후진 |
| **D** | 0.0 | -1.15 | 0.0 | 우측 이동 |
| **Q** | 1.15 | 1.15 | 0.0 | 전진+좌측 (대각선) |
| **E** | 1.15 | -1.15 | 0.0 | 전진+우측 (대각선) |

### 2.4 시나리오별 표준 패턴

#### 1box_left (왼쪽 회피)
```
W W A Q Q Q Q Q Q Q W W E E E W W
```
- **단계 분석**:
  1. `W W`: 초기 전진 (2프레임)
  2. `A`: 좌측 이동으로 박스 회피 준비 (1프레임)
  3. `Q Q Q Q Q Q Q`: 전진+좌측 대각선 이동 (7프레임)
  4. `W W`: 직선 전진 (2프레임)
  5. `E E E`: 전진+우측으로 원래 경로 복귀 (3프레임)
  6. `W W`: 최종 목표 지점까지 전진 (2프레임)

#### 1box_right (오른쪽 회피)
```
W W D E E E E E E E W W Q Q W W W
```
- **단계 분석**:
  1. `W W`: 초기 전진 (2프레임)
  2. `D`: 우측 이동으로 박스 회피 준비 (1프레임)
  3. `E E E E E E E`: 전진+우측 대각선 이동 (7프레임)
  4. `W W`: 직선 전진 (2프레임)
  5. `Q Q`: 전진+좌측으로 원래 경로 복귀 (2프레임)
  6. `W W W`: 최종 목표 지점까지 전진 (3프레임)

### 2.5 메타데이터 파일

#### core_patterns.json
```json
{
  "1box_left__core__medium": ["w", "w", "a", "q", ...],
  "1box_right__core__medium": ["w", "w", "d", "e", ...]
}
```
각 시나리오의 정규 동작 패턴을 정의합니다.

#### scenario_progress.json
```json
{
  "last_updated": "2025-12-04T13:56:15.259810",
  "scenario_stats": {
    "1box_left": 250,
    "1box_right": 250
  },
  "total_completed": 500,
  "total_target": 1000
}
```

---

## 3. 수집 프로세스

### 3.1 수집 도구
- **데이터 수집기**: `mobile_vla_data_collector.py`
- **ROS2 패키지**: `mobile_vla_package`
- **로봇 플랫폼**: 옴니휠 기반 모바일 로봇
- **센서**: RGB 카메라 (해상도 및 프레임 레이트는 설정 파일 참조)

### 3.2 수집 절차
1. **환경 설정**: 장애물(박스) 배치 및 로봇 초기 위치 설정
2. **시나리오 선택**: 데이터 수집기에서 시나리오 선택 (1box_left/1box_right)
3. **가이드 모드**:
   - **자동 모드**: `core_patterns.json`의 표준 패턴 사용
   - **수동 모드**: 사용자가 키보드로 직접 가이드 입력
4. **데이터 기록**: 로봇이 패턴을 따라 이동하며 각 프레임의 이미지와 동작 기록
5. **검증 및 저장**: 패턴 일치 여부 확인 후 `.h5` 파일로 저장

### 3.3 품질 관리 체크리스트
- ✅ 동작 시퀀스가 표준 패턴과 100% 일치
- ✅ 이미지 데이터 손상 없음
- ✅ 타임스탬프 정확성
- ✅ 파일 크기가 정상 범위 내 (평균 ~26MB)

---

## 4. 수집 과정에서 발생한 이슈 및 해결 방법

### 4.1 패턴 불일치 문제

#### 이슈 상세
초기 수집 과정에서 **총 1,009개의 파일** 중 **504개(50%)**가 목표 패턴과 불일치하는 문제가 발견되었습니다.

**1box_left 시나리오 분석 (2025-12-03)**:
- 수집된 파일: 645개
- 패턴 일치: 141개 (21.9%)
- 패턴 불일치: 504개 (78.1%)

**불일치 원인**:
1. **코드 기본값과 실제 데이터 불일치**
   - 코드에는 `Q`로 종료하는 패턴이 기본값으로 설정
   - 실제 수집된 데이터는 `W`로 종료되는 패턴
   - 원인: `default_guides` 정의와 실제 수집 시 사용된 가이드 간의 차이

2. **가이드 편집 후 모드 전환 문제**
   - 가이드를 수동으로 편집한 후에도 '데이터셋 모드'가 유지됨
   - 편집된 가이드가 무시되고 이전 패턴이 계속 사용됨

#### 해결 방법
1. **데이터 정제**:
   ```bash
   # 패턴 불일치 파일 509개를 legacy 디렉토리로 이동
   mv <mismatched_files> ROS_action/mobile_vla_dataset_legacy/
   ```
   - 결과: 순수 패턴 일치 데이터만 유지

2. **데이터 수집기 개선** (commit: `d8db936`):
   ```python
   # 가이드 편집 완료 시 자동으로 '수동 모드'로 전환
   # Auto Measurement 자동 시작 기능 추가
   ```

3. **패턴 검증 자동화**:
   - `analyze_exact_patterns.py` 스크립트로 수집 후 즉시 검증
   - 불일치 파일 자동 식별 및 리포팅

### 4.2 1box_right 초기 수집 불일치

#### 이슈 상세
1box_right 시나리오 첫 수집 시 **250개 중 5개(2%)**가 다수결 패턴과 불일치:

**불일치 패턴**:
- 4개 파일: `W W D E E E E E E E W W Q Q Q W W` (Q가 3개)
- 1개 파일: `W W D E E E E E E E W W W Q Q W W` (W가 추가됨)
- 표준 패턴: `W W D E E E E E E E W W Q Q W W W`

**불일치 파일 목록**:
1. `episode_20251203_211845_1box_hori_right_core_medium.h5`
2. `episode_20251203_212231_1box_hori_right_core_medium.h5`
3. `episode_20251203_212446_1box_hori_right_core_medium.h5`
4. `episode_20251203_212741_1box_hori_right_core_medium.h5`
5. `episode_20251203_214634_1box_hori_right_core_medium.h5`

#### 원인 분석
- 초기 수집 시 가이드 설정 미완료
- 테스트 가이드와 최종 확정 가이드 간의 차이

#### 해결 방법
1. 불일치 파일 5개를 legacy로 이동
2. 동일한 패턴으로 5개 재수집
3. 최종 검증 결과: **250/250 (100%)** 패턴 일치 ✅

### 4.3 Git LFS 문제

#### 이슈 상세
대용량 `.h5` 파일(총 13GB)을 Git에 직접 커밋하면서 발생한 문제:
- 저장소 크기 급증
- Push/Pull 속도 저하
- Git 성능 저하

#### 해결 방법
1. **Git LFS 설정**:
   ```bash
   git lfs install
   git lfs track "*.h5"
   ```

2. **Legacy 데이터 제외**:
   ```gitignore
   # .gitignore 추가
   ROS_action/mobile_vla_dataset_legacy/
   *.tar.gz
   ```

3. **결과**:
   - LFS를 통한 대용량 파일 효율적 관리
   - Push 시 평균 속도: 19-21 MB/s

### 4.4 데이터 수집 중단 및 재개

#### 이슈
장시간 수집 중 네트워크 문제, 센서 오류 등으로 중단되는 경우 발생.

#### 해결 방법
- **자동 체크포인트**: `scenario_progress.json`에 실시간 진행 상황 저장
- **중단 지점부터 재개 가능**: 수집기 재시작 시 자동으로 진행 상황 로드

---

## 5. 데이터 품질 관리

### 5.1 검증 체계

#### 자동 검증 스크립트
```python
# analyze_exact_patterns.py
- 각 파일의 동작 시퀀스 추출
- 표준 패턴과 비교 (17개 프레임 일치 여부)
- 유사도 점수 계산 (0-17점)
```

#### 품질 기준
- **최소 유사도**: 17/17 (100% 일치)
- **이미지 무결성**: HDF5 파일 읽기 테스트 통과
- **타임스탬프 연속성**: 프레임 간 시간 간격 일정

### 5.2 품질 통계

#### 현재 데이터셋 품질
- **1box_left**: 250/250 (100%) ✅
- **1box_right**: 250/250 (100%) ✅
- **전체 품질 점수**: 100%

#### Legacy 데이터 현황
- 총 509개 파일
- 평균 유사도: 약 12-14/17
- 보관 목적: 향후 패턴 변경 시 재활용 가능성

---

## 6. 통계 및 분석

### 6.1 수집 추이

#### 시간대별 수집 분포
| 시간대 | 수집량 | 비율 |
|--------|--------|------|
| 새벽 (00:00-06:00) | 103개 | 20.6% |
| 오전 (06:00-12:00) | 180개 | 36.0% |
| 저녁 (12:00-18:00) | 200개 | 40.0% |
| 밤 (18:00-24:00) | 17개 | 3.4% |

**인사이트**:
- 저녁 시간대 수집이 가장 활발 (40%)
- 밤 시간대는 수집이 저조 (3.4%)
- 오전~저녁 시간대가 전체의 96.6%

#### 일별 수집 추이
- **12월 3일**: 약 330개 (평균 13.75개/시간)
- **12월 4일**: 약 170개 (평균 17.0개/시간)

**속도 개선**:
- 수집 프로세스 최적화로 시간당 수집량 **23.6% 증가**

### 6.2 데이터 분포

#### 시나리오별 분포
```
1box_left:  ████████████████████████████████████████ 250 (50%)
1box_right: ████████████████████████████████████████ 250 (50%)
```
완벽한 균형 분포 달성 ✅

#### 파일 크기 분포
- **평균 파일 크기**: ~26 MB
- **총 데이터셋 크기**: 13 GB
- **압축 후 크기**: ~4.5 GB (tar.gz)

---

## 7. 향후 계획

### 7.1 단기 계획 (1-2주)
- [ ] **2box 시나리오 가이드 정의**
  - 2box_left, 2box_right, 2box_center 등
  - 더 복잡한 회피 패턴 설계

- [ ] **추가 500개 수집**
  - 목표: 총 1,000개 완료
  - 예상 소요 시간: ~33시간

### 7.2 중기 계획 (1개월)
- [ ] **데이터 증강 (Augmentation)**
  - 이미지 변환 (회전, 밝기 조절 등)
  - 동작 시퀀스 미세 조정

- [ ] **다양한 환경 조건 추가**
  - 조명 변화
  - 장애물 크기 및 위치 다양화

### 7.3 장기 계획 (3개월)
- [ ] **멀티 모달 데이터 추가**
  - LiDAR 데이터
  - IMU 센서 데이터

- [ ] **실시간 데이터 검증 시스템**
  - 수집 중 즉시 품질 체크
  - 이상 데이터 자동 재수집

---

## 8. 부록

### 8.1 파일 명명 규칙
```
episode_<YYYYMMDD>_<HHMMSS>_<scenario>_<difficulty>.h5
```
- `YYYYMMDD`: 날짜
- `HHMMSS`: 시간
- `scenario`: 시나리오 이름 (예: 1box_hori_left, 1box_hori_right)
- `difficulty`: 난이도 (core, medium 등)

### 8.2 주요 커밋 히스토리
| 날짜 | 커밋 | 설명 |
|------|------|------|
| 2025-12-03 | `641e460` | 데이터셋 정리 - 목표 패턴 일치 파일만 유지 |
| 2025-12-03 | `8b28d64` | 데이터셋 상태 업데이트, TODO 정리 |
| 2025-12-03 | `d41d34b` | Legacy 데이터셋 gitignore 추가 |
| 2025-12-03 | `22f89b9` | Git 상태 정리 - 250개 새 데이터셋 추가 |
| 2025-12-04 | `909fa65` | 1box_hori_right 데이터셋 추가 |
| 2025-12-04 | `f0c8c69` | 불일치 파일 정리, 새 에피소드 추가 |
| 2025-12-04 | `af48f63` | 5개 신규 에피소드 및 보고서 추가 |

### 8.3 참고 문서
- `docs/mobile_vla_data_collector_spec.md` - 데이터 수집기 기능 명세
- `docs/guide_analysis_report.md` - 가이드 패턴 분석 보고서
- `TODO.md` - 작업 항목 및 우선순위

### 8.4 연락처 및 기여자
- **프로젝트 저장소**: `github.com/minuum/vla`
- **브랜치**: `feature/mobile-vla-refactor`
- **기여자**: VLA Data Collection Team

---

## 📊 요약 대시보드

```
┌─────────────────────────────────────────────────────────┐
│  Mobile VLA Dataset Status                              │
├─────────────────────────────────────────────────────────┤
│  총 수집량:        500 / 1,000 (50%)  ████████░░░░░░░░  │
│  데이터 품질:      100% ✅                               │
│  데이터 크기:      13 GB                                 │
│  수집 기간:        33시간                                │
│  평균 속도:        15.3 eps/hr                           │
│                                                          │
│  시나리오별:                                             │
│    1box_left:    250 ████████████████████████████████   │
│    1box_right:   250 ████████████████████████████████   │
│    2box_*:         0 ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░   │
│                                                          │
│  Legacy:           509개 (별도 보관)                     │
└─────────────────────────────────────────────────────────┘
```

---

**문서 버전**: 1.0  
**최종 업데이트**: 2025-12-04 14:42  
**라이선스**: MIT
