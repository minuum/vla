# 📊 데이터셋 수집 변경 사항 (2025-11-04)

## 🎯 주요 변경 목적
데이터셋 수집 과정을 단순화하고 효율성을 높이기 위한 변경 사항

---

## 📝 변경 사항 상세

### 1. **태스크 변경**
- **이전**: 컵 도달 시나리오
- **변경**: 탄산음료 페트병 도달 시나리오
- **영향**: 모든 로그 메시지 및 설명 업데이트

### 2. **데이터셋 목표 변경**
- **이전**: 40개 (4개 시나리오 × 10개)
- **변경**: 1000개 (4개 시나리오 × 250개)
- **분배**:
  - 시나리오당 250개
  - Core: 150개 (60%), Variant: 100개 (40%)
  - 거리 분배: Core(50/75/25), Variant(25/25/50)

### 3. **시간대별 수집 계획 추가**
- **낮 (13:00-15:00)**: 200개
- **밤 (20:00-22:00)**: 500개 (주 학습 데이터)
- **새벽 (00:00-04:00)**: 300개
- **자동 분류**: `datetime.now()` 기반으로 자동 분류 및 통계 업데이트
- **메타데이터**: H5 파일에 `time_period`, `collection_datetime`, `collection_hour`, `collection_minute` 저장

### 4. **배치 타입 선택 단계 제거 (단순화)**
- **이전**: N → 시나리오 → 배치타입(V/H) → 패턴(C/V) → 거리(J/K/L)
- **변경**: N → 시나리오(1-4) → 패턴(C/V) → 거리(J/K/L)
- **배치 타입 기본값**: 가로(hori)로 자동 설정
- **이유**: 
  - 학습 코드에서 vert/hori 명령어가 동일함
  - 메타데이터로만 저장되고 학습에 사용되지 않음
  - 수집 단계 단순화로 효율성 향상

### 5. **카테고리 분류 vs 수집 목표 구분**
- **카테고리**: 데이터셋 통계 모니터링용 (프레임 수 기준)
  - short (1-10): 100개
  - medium (11-25): 700개
  - long (26-50): 150개
  - extra_long (51+): 50개
- **실제 수집 목표**: 18프레임 기준 (RoboVLMs: window=8 + pred_next=10)

### 6. **에피소드명 형식 변경**
- **이전**: `episode_{timestamp}_{num_box}_{layout_type}_{direction}_{pattern}_{distance}`
  - 예: `episode_20251030_132725_1box_vert_left_core_close`
- **변경**: `episode_{timestamp}_{num_box}_{layout_type}_{direction}_{pattern}_{distance}`
  - 예: `episode_20251104_155500_1box_hori_left_core_close`
  - 배치 타입은 기본값 "hori"로 자동 설정
- **기존 형식 호환**: `extract_scenario_from_episode_name()`에서 기존 형식도 처리

### 7. **경로 문제 해결**
- **문제**: 상대 경로 사용 시 현재 작업 디렉토리가 없을 때 오류 발생
- **해결**: 
  - 환경변수 `VLA_DATASET_DIR` 우선 사용
  - 없으면 홈 디렉토리 기준 절대 경로: `~/vla/ROS_action/install/mobile_vla_dataset`
  - `parents=True`로 부모 디렉토리 자동 생성

---

## 🔄 수집 흐름 (변경 후)

```
1. N키 → 시나리오 선택 메뉴 표시
2. 1-4키 → 시나리오 선택 → 패턴 선택 모드로 전환
3. C/V키 → 패턴 선택 (Core/Variant) → 거리 선택 모드로 전환
4. J/K/L키 → 거리 선택 (Close/Medium/Far) → 에피소드 시작
```

**배치 타입**: 자동으로 "hori"로 설정됨 (선택 단계 없음)

---

## 📊 데이터셋 구조

### 시나리오 구성 (4개)
1. `1box_left`: 1박스-왼쪽경로 (250개)
2. `1box_right`: 1박스-오른쪽경로 (250개)
3. `2box_left`: 2박스-왼쪽경로 (250개)
4. `2box_right`: 2박스-오른쪽경로 (250개)

### 패턴 분배 (시나리오당)
- **Core**: 150개
  - close: 50개
  - medium: 75개
  - far: 25개
- **Variant**: 100개
  - close: 25개
  - medium: 25개
  - far: 50개

### 시간대 분배 (전체)
- **낮 (13:00-15:00)**: 200개
- **밤 (20:00-22:00)**: 500개 (주 학습 데이터)
- **새벽 (00:00-04:00)**: 300개

---

## 💾 저장된 메타데이터

### H5 파일 속성
- `episode_name`: 에피소드 이름
- `total_duration`: 총 소요 시간
- `num_frames`: 프레임 수
- `action_chunk_size`: 액션 청크 크기
- `obstacle_layout_type`: 장애물 배치 타입 (기본값: "hori")
- `time_period`: 시간대 ("day", "night", "dawn")
- `collection_datetime`: 수집 시간 (ISO 형식)
- `collection_hour`: 수집 시간 (시)
- `collection_minute`: 수집 시간 (분)

---

## 🎯 핵심 개선 사항

1. **단순화**: 배치 타입 선택 단계 제거 → 수집 단계 1개 감소
2. **자동화**: 시간대 자동 분류 및 통계 업데이트
3. **안정성**: 절대 경로 사용으로 경로 문제 해결
4. **확장성**: 목표 1000개로 증가, 시간대별 분포 관리
5. **호환성**: 기존 데이터 형식과의 호환성 유지

---

## 📌 참고 사항

- 배치 타입은 학습에 사용되지 않지만, 기존 형식 호환을 위해 기본값으로 저장됨
- 카테고리 분류는 통계 모니터링용이며, 실제 수집 목표는 18프레임 기준
- 시간대 분류는 에피소드 종료 시점의 시간을 기준으로 자동 분류됨
- 환경변수 `VLA_DATASET_DIR`로 데이터 저장 경로 변경 가능

