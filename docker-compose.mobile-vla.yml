version: '3.8'

services:
  # =============================================================================
  # ğŸš€ Mobile VLA ë©”ì¸ ì»¨í…Œì´ë„ˆ
  # PyTorch 2.3.0 + VLA ì¶”ë¡  + ROS2 ë…¸ë“œë“¤
  # =============================================================================
  mobile_vla_main:
    build:
      context: .
      dockerfile: Dockerfile.mobile-vla
    container_name: mobile_vla_main
    image: mobile_vla:pytorch-2.3.0-cuda
    
    # GPU ë° í•˜ë“œì›¨ì–´ ì ‘ê·¼
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=${XAUTHORITY}
    
    # ë„¤íŠ¸ì›Œí¬ ì„¤ì •
    network_mode: host
    
    # ë³¼ë¥¨ ë§ˆìš´íŠ¸
    volumes:
      # í˜¸ìŠ¤íŠ¸ CUDA ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§ˆìš´íŠ¸
      - /usr/local/cuda:/usr/local/cuda:ro
      - /usr/lib/aarch64-linux-gnu:/usr/lib/aarch64-linux-gnu:ro
      # í”„ë¡œì íŠ¸ ì½”ë“œ
      - ./vla:/workspace/vla
      - ./ROS_action:/workspace/vla/ROS_action
      # X11 ë””ìŠ¤í”Œë ˆì´
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # ì¹´ë©”ë¼ ì¥ì¹˜
      - /dev/video0:/dev/video0:rw
      # ë¡œë´‡ ì‹œë¦¬ì–¼ í¬íŠ¸ (í•„ìš”ì‹œ)
      - /dev/ttyUSB0:/dev/ttyUSB0:rw
      - /dev/ttyUSB1:/dev/ttyUSB1:rw
      # í‚¤ë³´ë“œ ì…ë ¥
      - /dev/input:/dev/input:ro
    
    # ê¶Œí•œ ì„¤ì •
    privileged: true
    devices:
      - /dev/video0:/dev/video0
      - /dev/ttyUSB0:/dev/ttyUSB0
      - /dev/ttyUSB1:/dev/ttyUSB1
    
    # í¬íŠ¸ ë…¸ì¶œ
    ports:
      - "8888:8888"  # Jupyter Notebook
      - "6006:6006"  # TensorBoard
      - "11311:11311"  # ROS Master
    
    # í—¬ìŠ¤ì²´í¬
    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # ì‹œì‘ ëª…ë ¹ì–´
    command: >
      bash -c "
        echo 'ğŸš€ Mobile VLA ì‹œìŠ¤í…œ ì‹œì‘...' &&
        echo 'ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸...' &&
        /usr/local/bin/healthcheck.sh &&
        echo 'ğŸ¤– ROS2 í™˜ê²½ ì„¤ì •...' &&
        source /opt/ros/humble/setup.bash &&
        source /workspace/vla/ROS_action/install/setup.bash &&
        echo 'ğŸ¯ ë…¸ë“œ ì‹¤í–‰ ì¤€ë¹„ ì™„ë£Œ!' &&
        echo 'ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:' &&
        echo '   ros2 run camera_pub camera_publisher_continuous' &&
        echo '   ros2 run vla_inference vla_inference_node' &&
        echo '   ros2 run robot_control robot_control_node' &&
        echo '   ros2 run mobile_vla_data_collector mobile_vla_data_collector' &&
        echo '' &&
        bash
      "
    
    # ì¬ì‹œì‘ ì •ì±…
    restart: unless-stopped
    
    # ë¦¬ì†ŒìŠ¤ ì œí•œ
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # =============================================================================
  # ğŸ“Š ëª¨ë‹ˆí„°ë§ ì»¨í…Œì´ë„ˆ (ì„ íƒì‚¬í•­)
  # ì‹œìŠ¤í…œ ìƒíƒœ ë° ë¡œê·¸ ëª¨ë‹ˆí„°ë§
  # =============================================================================
  mobile_vla_monitor:
    image: nginx:alpine
    container_name: mobile_vla_monitor
    ports:
      - "8080:80"
    volumes:
      - ./monitoring:/usr/share/nginx/html:ro
    depends_on:
      - mobile_vla_main
    restart: unless-stopped
    profiles:
      - monitoring

  # =============================================================================
  # ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì»¨í…Œì´ë„ˆ (ì„ íƒì‚¬í•­)
  # ì‹¤í—˜ ë°ì´í„° ì €ì¥
  # =============================================================================
  mobile_vla_db:
    image: postgres:13-alpine
    container_name: mobile_vla_db
    environment:
      POSTGRES_DB: mobile_vla
      POSTGRES_USER: vla_user
      POSTGRES_PASSWORD: vla_password
    volumes:
      - mobile_vla_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    restart: unless-stopped
    profiles:
      - database

# =============================================================================
# ğŸ“¦ ë³¼ë¥¨ ì •ì˜
# =============================================================================
volumes:
  mobile_vla_data:
    driver: local

# =============================================================================
# ğŸŒ ë„¤íŠ¸ì›Œí¬ ì •ì˜
# =============================================================================
networks:
  default:
    name: mobile_vla_network
    driver: bridge