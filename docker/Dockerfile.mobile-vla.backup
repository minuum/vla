# =============================================================================
# ğŸš€ Mobile VLA RoboVLMs Docker í™˜ê²½ - ê²€ì¦ëœ ë² ì´ìŠ¤ ê¸°ë°˜
# ê¸°ì¡´ ì‘ë™í•˜ëŠ” VLA í™˜ê²½ì— RoboVLMs ì‹œìŠ¤í…œ ì¶”ê°€
# =============================================================================

# ë² ì´ìŠ¤ ì´ë¯¸ì§€: ê²€ì¦ëœ Jetson PyTorch (43.7GB ì´ë¯¸ì§€ ê¸°ë°˜)
    FROM nvcr.io/nvidia/l4t-pytorch:r35.2.1-pth2.0-py3

# ë©”íƒ€ë°ì´í„°
LABEL maintainer="Mobile VLA RoboVLMs Team"
LABEL description="Mobile VLA RoboVLMs System with CSI Camera & ROS2 Humble - Based on Verified VLA Environment"
LABEL version="1.0-robovlms"
LABEL base="vla_app_final_restored"

# ì‚¬ìš©ì ì„¤ì •
USER root

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ê¸°ì¡´ vla_app_finalê³¼ ë™ì¼)
ENV DEBIAN_FRONTEND=noninteractive
ENV LANGUAGE=en_US:en
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV CUDA_HOME=/usr/local/cuda
ENV NVCC_PATH=/usr/local/cuda/bin/nvcc
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=all
ENV CUDAARCHS=87
ENV CUDA_ARCHITECTURES=87
ENV PATH="/root/.local/bin:/root/.cargo/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
ENV PYTHONUNBUFFERED=1
ENV RMW_IMPLEMENTATION=rmw_cyclonedx_cpp
ENV HF_HOME=/root/.cache/huggingface

# Jetson ì „ìš© í™˜ê²½ ì„¤ì • (ê¸°ì¡´ê³¼ ë™ì¼) - pip ì¸ë±ìŠ¤ëŠ” ê¸°ë³¸ PyPI ì‚¬ìš©
ENV TAR_INDEX_URL=http://jetson.webredirect.org:8000/jp6/cu122
# ENV PIP_INDEX_URL=http://jetson.webredirect.org/jp6/cu122
# ENV PIP_TRUSTED_HOST=jetson.webredirect.org

# Mobile VLA RoboVLMs ì „ìš© í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€
ENV ROS_DOMAIN_ID=42
ENV ROS_LOCALHOST_ONLY=0
ENV MOBILE_VLA_DATA_DIR=/workspace/vla/mobile_vla_dataset
ENV MOBILE_VLA_LOG_LEVEL=INFO
ENV HUGGING_FACE_HUB_TOKEN=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

# 1. ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° ê¸°ë³¸ ë„êµ¬ ì„¤ì¹˜ (ê¸°ì¡´ + RoboVLMs ì¶”ê°€)
RUN apt-get update && \
    # OpenCV ì¶©ëŒ í•´ê²°ì„ ìœ„í•œ ê°•ì œ ì œê±°
    apt-get remove -y --purge opencv-libs opencv-dev libopencv libopencv-dev || true && \
    apt-get autoremove -y && \
    apt-get clean && \
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        -o Dpkg::Options::="--force-overwrite" \
        -o Dpkg::Options::="--force-confdef" \
        -o Dpkg::Options::="--force-confnew" \
        # ê¸°ì¡´ vla_app_final íŒ¨í‚¤ì§€ë“¤ (libhdf5-serial-dev ì¤‘ë³µ ì œê±°)
        hdf5-tools libhdf5-dev \
        curl gnupg lsb-release \
        # Mobile VLA ì¶”ê°€ íŒ¨í‚¤ì§€ë“¤
        git vim nano htop tree \
        build-essential cmake pkg-config \
        # GStreamer (CSI ì¹´ë©”ë¼ìš©) - OpenCVëŠ” ì˜ì¡´ì„±ìœ¼ë¡œ ì„¤ì¹˜ë  ì˜ˆì •
        libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
        libgstreamer-plugins-bad1.0-dev gstreamer1.0-plugins-base \
        gstreamer1.0-plugins-good gstreamer1.0-plugins-bad \
        gstreamer1.0-libav gstreamer1.0-tools \
        # ì˜¤ë””ì˜¤ ì§€ì›
        libasound2-dev portaudio19-dev \
        # ì¶”ê°€ ìœ í‹¸ë¦¬í‹°
        openssh-client rsync \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# 1.5. OpenCV í™•ì¸ (ì‹œìŠ¤í…œì— ì´ë¯¸ ì„¤ì¹˜ëœ NVIDIA ìµœì í™” OpenCV ì‚¬ìš©)
RUN python3 -c "import cv2; print(f'OpenCV version: {cv2.__version__}'); print('âœ… NVIDIA optimized OpenCV is available')" || echo "OpenCV will be installed via pip if needed"

# 2. ROS 2 Foxy ì„¤ì¹˜ (Ubuntu 20.04ìš©)
RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null && \
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        -o Dpkg::Options::="--force-overwrite" \
        -o Dpkg::Options::="--force-confdef" \
        -o Dpkg::Options::="--force-confnew" \
        # X11/Qt ë¼ì´ë¸ŒëŸ¬ë¦¬ (ê¸°ì¡´)
        libxcb-randr0-dev libxcb-xtest0-dev libxcb-xinerama0-dev \
        libxcb-shape0-dev libxcb-xkb-dev libqt5x11extras5 \
        libxkbcommon-x11-0 libgl1-mesa-glx \
        python3-pip \
        # ROS 2 Foxy íŒ¨í‚¤ì§€ (Ubuntu 20.04ìš©)
        ros-foxy-desktop \
        ros-dev-tools \
        python3-colcon-common-extensions \
        python3-rosdep \
        ros-foxy-cv-bridge \
        python3-opencv \
        # Mobile VLAìš© ì¶”ê°€ ROS2 íŒ¨í‚¤ì§€
        ros-foxy-image-transport \
        ros-foxy-camera-info-manager \
    && apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 3. rosdep ì´ˆê¸°í™”
RUN rosdep init || true && rosdep update

# 4. Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ê¸°ë³¸ íŒ¨í‚¤ì§€ë§Œ ì„¤ì¹˜)
RUN pip3 install --no-cache-dir --upgrade pip && \
    pip3 install --no-cache-dir \
        Pillow \
    && rm -rf /root/.cache/pip

# 5. Python ë²„ì „ í™•ì¸ ë° ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN python3 --version && \
    pip3 install --no-cache-dir \
        numpy \
        requests \
        pyserial \
    && rm -rf /root/.cache/pip

# 6. Transformers ë° ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (ì•ˆì „í•œ ë²„ì „)
RUN pip3 install --no-cache-dir \
        "transformers<4.47.0" \
        "tokenizers<0.16.0" \
        "accelerate<0.21.0" \
        "huggingface_hub<0.17.0" \
    && rm -rf /root/.cache/pip

# 6. RoboVLMs ëª¨ë¸ ì‚¬ì „ ë‹¤ìš´ë¡œë“œ (MAE 0.222 ëª¨ë¸) - ì„ íƒì 
RUN python3 -c "import torch; print(f'PyTorch {torch.__version__} - CUDA: {torch.cuda.is_available()}')" && \
    python3 -c "from transformers import AutoModel, AutoProcessor; print('Testing transformers import...')" || echo "Transformers will be installed at runtime"

# 9. PyTorch CUDA í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ (ê¸°ì¡´ê³¼ ë™ì¼)
COPY pytorch_cuda_test.py /usr/local/bin/pytorch_cuda_test.py
RUN chmod +x /usr/local/bin/pytorch_cuda_test.py

# ğŸ”Ÿ ì‘ì—…ê³µê°„ ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /workspace/vla \
    && mkdir -p /workspace/vla/ROS_action \
    && mkdir -p /workspace/vla/mobile_vla_dataset \
    && mkdir -p /workspace/vla/.cache/huggingface \
    && mkdir -p /workspace/vla/logs \
    && chmod -R 777 /workspace/vla

# 1ï¸âƒ£1ï¸âƒ£ .bashrc ì„¤ì • (ê¸°ì¡´ + RoboVLMs ì¶”ê°€)
RUN echo "" >> /root/.bashrc && \
    echo "# =============================================================================" >> /root/.bashrc && \
    echo "# ğŸš€ Mobile VLA RoboVLMs Docker í™˜ê²½ - ê²€ì¦ëœ VLA ê¸°ë°˜" >> /root/.bashrc && \
    echo "# =============================================================================" >> /root/.bashrc && \
    echo "" >> /root/.bashrc && \
    echo "# ROS 2 Foxy environment setup" >> /root/.bashrc && \
    echo "source /opt/ros/foxy/setup.bash" >> /root/.bashrc && \
    echo "export ROS_DOMAIN_ID=42" >> /root/.bashrc && \
    echo "export ROS_LOCALHOST_ONLY=0" >> /root/.bashrc && \
    echo "export HUGGING_FACE_HUB_TOKEN=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" >> /root/.bashrc && \
    echo "" >> /root/.bashrc && \
    echo "# ROS_action ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìë™ ì†Œì‹± (ì¡´ì¬í•  ê²½ìš°)" >> /root/.bashrc && \
    echo "if [ -f \"/workspace/vla/ROS_action/install/setup.bash\" ]; then" >> /root/.bashrc && \
    echo "    source /workspace/vla/ROS_action/install/setup.bash" >> /root/.bashrc && \
    echo "fi" >> /root/.bashrc && \
    echo "" >> /root/.bashrc && \
    echo "# RoboVLMs Poetry Project Helper (ê¸°ì¡´ ë‚´ìš© ìœ ì§€)" >> /root/.bashrc && \
    echo "alias activate_robovlms='cd /workspace/RoboVLMs && source \$(poetry env info --path)/bin/activate'" >> /root/.bashrc && \
    echo "" >> /root/.bashrc && \
    echo "# PyTorch & CUDA Test Alias (ê¸°ì¡´ ë‚´ìš© ìœ ì§€)" >> /root/.bashrc && \
    echo "alias torch_cuda_test='python3 /usr/local/bin/pytorch_cuda_test.py'" >> /root/.bashrc && \
    echo "" >> /root/.bashrc && \
    echo "# Mobile VLA RoboVLMs ì „ìš© alias" >> /root/.bashrc && \
    echo "alias vla-build='cd /workspace/vla/ROS_action && colcon build'" >> /root/.bashrc && \
    echo "alias vla-source='source /opt/ros/foxy/setup.bash && source /workspace/vla/ROS_action/install/setup.bash'" >> /root/.bashrc && \
    echo "alias vla-camera='ros2 run camera_pub camera_publisher_continuous'" >> /root/.bashrc && \
    echo "alias vla-collect='cd /workspace/vla && python mobile_vla_data_collector.py'" >> /root/.bashrc && \
    echo "alias cuda-test='python -c \"import torch; print(f\\\"PyTorch: {torch.__version__}\\\"); print(f\\\"CUDA Available: {torch.cuda.is_available()}\\\"); print(f\\\"CUDA Device: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else \\\"N/A\\\"}\\\")\"'" >> /root/.bashrc && \
    echo "" >> /root/.bashrc && \
    echo "# Container Run ë©”ë‰´ alias" >> /root/.bashrc && \
    echo "alias container-run='/usr/local/bin/container_run_enhanced.sh'" >> /root/.bashrc && \
    echo "alias mobile-vla-test='cd /workspace/vla && python kosmos_camera_test.py'" >> /root/.bashrc && \
    echo "alias run-mobile-vla='cd /workspace/vla && python launch_mobile_vla_system.py'" >> /root/.bashrc && \
    echo "" >> /root/.bashrc && \
    echo "# RoboVLMs ì‹œìŠ¤í…œ ì‹¤í–‰ alias" >> /root/.bashrc && \
    echo "alias robovlms-system='cd /workspace/vla/ROS_action && source /opt/ros/foxy/setup.bash && colcon build --packages-select mobile_vla_package && source install/setup.bash && ros2 launch mobile_vla_package robovlms_system.launch.py'" >> /root/.bashrc && \
    echo "alias robovlms-inference='cd /workspace/vla/ROS_action && source /opt/ros/foxy/setup.bash && python3 src/mobile_vla_package/mobile_vla_package/robovlms_inference.py'" >> /root/.bashrc && \
    echo "alias robovlms-test='cd /workspace/vla && python3 -c \"import torch; from transformers import AutoModel, AutoProcessor; print(\\\"Testing RoboVLMs model...\\\"); model = AutoModel.from_pretrained(\\\"minium/mobile-vla-omniwheel\\\"); print(\\\"âœ… RoboVLMs model loaded successfully (MAE 0.222)\\\")\"'" >> /root/.bashrc && \
    echo "" >> /root/.bashrc && \
    echo "# í™˜ì˜ ë©”ì‹œì§€" >> /root/.bashrc && \
    echo "echo \"ğŸš€ Mobile VLA RoboVLMs Docker í™˜ê²½ (ê²€ì¦ëœ VLA ê¸°ë°˜)\"" >> /root/.bashrc && \
    echo "echo \"ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:\"" >> /root/.bashrc && \
    echo "echo \"   vla-build     : ROS2 ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë¹Œë“œ\"" >> /root/.bashrc && \
    echo "echo \"   vla-source    : ROS2 í™˜ê²½ ì†Œì‹±\"" >> /root/.bashrc && \
    echo "echo \"   vla-camera    : CSI ì¹´ë©”ë¼ ë…¸ë“œ ì‹¤í–‰\"" >> /root/.bashrc && \
    echo "echo \"   vla-collect   : Mobile VLA ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘\"" >> /root/.bashrc && \
    echo "echo \"   cuda-test     : CUDA/PyTorch ìƒíƒœ í™•ì¸\"" >> /root/.bashrc && \
    echo "echo \"   torch_cuda_test : ê¸°ì¡´ VLA CUDA í…ŒìŠ¤íŠ¸\"" >> /root/.bashrc && \
    echo "echo \"   container-run : ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì‹¤í–‰ ë©”ë‰´\"" >> /root/.bashrc && \
    echo "echo \"   mobile-vla-test : Mobile VLA ì¹´ë©”ë¼ í…ŒìŠ¤íŠ¸\"" >> /root/.bashrc && \
    echo "echo \"   run-mobile-vla : Mobile VLA ì‹œìŠ¤í…œ ì‹¤í–‰\"" >> /root/.bashrc && \
    echo "echo \"   robovlms-system : RoboVLMs ì‹œìŠ¤í…œ ì‹¤í–‰ (ê¶Œì¥)\"" >> /root/.bashrc && \
    echo "echo \"   robovlms-inference : RoboVLMs ì¶”ë¡  ë…¸ë“œë§Œ ì‹¤í–‰\"" >> /root/.bashrc && \
    echo "echo \"   robovlms-test : RoboVLMs ëª¨ë¸ í…ŒìŠ¤íŠ¸\"" >> /root/.bashrc && \
    echo "echo \"\"" >> /root/.bashrc

# 1ï¸âƒ£2ï¸âƒ£ í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN echo '#!/bin/bash' > /usr/local/bin/healthcheck.sh && \
    echo 'echo "ğŸ” Mobile VLA RoboVLMs Docker í™˜ê²½ ìƒíƒœ í™•ì¸..."' >> /usr/local/bin/healthcheck.sh && \
    echo 'python3 -c "import torch; print(f\"âœ… PyTorch {torch.__version__} - CUDA: {torch.cuda.is_available()}\")"' >> /usr/local/bin/healthcheck.sh && \
    echo 'python3 -c "import cv2; print(f\"âœ… OpenCV {cv2.__version__}\")"' >> /usr/local/bin/healthcheck.sh && \
    echo 'python3 -c "import transformers; print(f\"âœ… Transformers {transformers.__version__}\")"' >> /usr/local/bin/healthcheck.sh && \
    echo 'python3 -c "import h5py; print(f\"âœ… HDF5 {h5py.__version__}\")"' >> /usr/local/bin/healthcheck.sh && \
    echo 'source /opt/ros/foxy/setup.bash && echo "âœ… ROS2 Foxy ì¤€ë¹„ ì™„ë£Œ"' >> /usr/local/bin/healthcheck.sh && \
    echo 'echo "ğŸ‰ ëª¨ë“  ì‹œìŠ¤í…œ ì •ìƒ - RoboVLMs í™˜ê²½ ê¸°ë°˜!"' >> /usr/local/bin/healthcheck.sh && \
    chmod +x /usr/local/bin/healthcheck.sh

# 1ï¸âƒ£3ï¸âƒ£ ë³¼ë¥¨ ë§ˆìš´íŠ¸ í¬ì¸íŠ¸ ìƒì„±
VOLUME ["/workspace/vla", "/workspace/vla/.cache"]

# 1ï¸âƒ£4ï¸âƒ£ í¬íŠ¸ ë…¸ì¶œ (ë””ë²„ê¹…/ëª¨ë‹ˆí„°ë§ìš©)
EXPOSE 8888 6006

# 1ï¸âƒ£5ï¸âƒ£ í—¬ìŠ¤ì²´í¬ ì„¤ì •
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD /usr/local/bin/healthcheck.sh

# 1ï¸âƒ£6ï¸âƒ£ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì • (vla í´ë”ë¡œ ë³€ê²½)
WORKDIR /workspace/vla

# 1ï¸âƒ£7ï¸âƒ£ ìë™ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
COPY ROS_action/src/camera_pub/camera_pub/container_init.sh /usr/local/bin/container_init.sh
COPY ROS_action/src/camera_pub/camera_pub/container_run_enhanced.sh /usr/local/bin/container_run_enhanced.sh
RUN chmod +x /usr/local/bin/container_init.sh && \
    chmod +x /usr/local/bin/container_run_enhanced.sh

# 1ï¸âƒ£8ï¸âƒ£ ê¸°ë³¸ ëª…ë ¹ì–´ (ìë™ ì´ˆê¸°í™” í¬í•¨)
CMD ["/usr/local/bin/container_init.sh"]

# =============================================================================
# ë¹Œë“œ ëª…ë ¹ì–´:
# docker build -t mobile_vla:robovlms -f Dockerfile.mobile-vla .
# =============================================================================