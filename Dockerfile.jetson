# =============================================================================
# ğŸš€ Jetson Orin NX ìµœì í™” Mobile VLA Docker í™˜ê²½
# JetPack 6.0 (L4T R36.4) ê¸°ë°˜ - 2025ë…„ ìµœì‹  ë²„ì „
# =============================================================================

# 1ï¸âƒ£ NVIDIA Jetson ìµœì‹  ë² ì´ìŠ¤ ì´ë¯¸ì§€ (L4T R36.4 + PyTorch 2.6)
FROM dustynv/pytorch:2.6-r36.4.0

# 2ï¸âƒ£ ë©”íƒ€ë°ì´í„°
LABEL maintainer="Mobile VLA Team"
LABEL description="Jetson Orin NX ìµœì í™” Mobile VLA + ROS2 Humble í†µí•© í™˜ê²½"
LABEL version="1.0.0"
LABEL jetpack.version="6.0"
LABEL l4t.version="36.4.0"

# 3ï¸âƒ£ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV DEBIAN_FRONTEND=noninteractive
ENV RMW_IMPLEMENTATION=rmw_cyclonedx_cpp
ENV PYTHONUNBUFFERED=1
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# ROS2 í™˜ê²½ ë³€ìˆ˜
ENV ROS_DISTRO=humble
ENV ROS_DOMAIN_ID=42
ENV ROS_LOCALHOST_ONLY=0

# CUDA í™˜ê²½ ë³€ìˆ˜ (JetPack 6.0 ê¸°ì¤€)
ENV CUDA_HOME=/usr/local/cuda-12.2
ENV PATH=/usr/local/cuda-12.2/bin:$PATH
ENV LD_LIBRARY_PATH=/usr/local/cuda-12.2/lib64:$LD_LIBRARY_PATH

# PyTorch/NVIDIA ìµœì í™”
ENV PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:512
ENV TORCH_DTYPE=float16
ENV TRANSFORMERS_CACHE=/workspace/.cache/huggingface
ENV HF_HOME=/workspace/.cache/huggingface

# 4ï¸âƒ£ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /workspace

# 5ï¸âƒ£ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ ìœ í‹¸ë¦¬í‹° ì„¤ì¹˜
RUN apt-get update && apt-get install -y --no-install-recommends \
    # ê¸°ë³¸ ìœ í‹¸ë¦¬í‹°
    curl wget gnupg lsb-release ca-certificates \
    git vim nano htop tree \
    # ë¹Œë“œ ë„êµ¬
    build-essential cmake pkg-config \
    # Python ê°œë°œ ë„êµ¬
    python3-pip python3-dev python3-venv \
    # OpenCV/ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜ì¡´ì„±
    libopencv-dev python3-opencv \
    libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
    libgstreamer-plugins-bad1.0-dev gstreamer1.0-plugins-base \
    gstreamer1.0-plugins-good gstreamer1.0-plugins-bad \
    gstreamer1.0-libav gstreamer1.0-tools \
    # ì˜¤ë””ì˜¤/ë¹„ë””ì˜¤ ë¼ì´ë¸ŒëŸ¬ë¦¬
    libasound2-dev portaudio19-dev \
    ffmpeg libavformat-dev libavcodec-dev libswresample-dev \
    # HDF5 (Mobile VLA ë°ì´í„° ì €ì¥ìš©)
    libhdf5-dev hdf5-tools \
    # ë„¤íŠ¸ì›Œí‚¹/í†µì‹ 
    openssh-client rsync \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# 6ï¸âƒ£ ROS2 Humble ì„¤ì¹˜ (Jetsonì— ìµœì í™”ëœ ë°©ì‹)
RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null \
    && apt-get update && apt-get install -y --no-install-recommends \
        ros-humble-desktop-full \
        ros-dev-tools \
        python3-colcon-common-extensions \
        python3-rosdep \
        ros-humble-cv-bridge \
        ros-humble-image-transport \
        ros-humble-camera-info-manager \
        ros-humble-rmw-cyclonedx-cpp \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# 7ï¸âƒ£ rosdep ì´ˆê¸°í™”
RUN rosdep init || true && rosdep update

# 8ï¸âƒ£ Python ì˜ì¡´ì„± ì„¤ì¹˜ (Mobile VLA + RoboVLMs í†µí•©)
RUN pip3 install --no-cache-dir --upgrade pip setuptools wheel && \
    pip3 install --no-cache-dir \
        # PyTorch ìƒíƒœê³„ (Jetsonì— ìµœì í™”ë¨)
        transformers==4.41.2 \
        accelerate>=1.7.0 \
        safetensors>=0.3.0 \
        tokenizers==0.21.1 \
        # ì»´í“¨í„° ë¹„ì „
        opencv-python==4.11.0.86 \
        pillow \
        einops>=0.8.1 \
        # ê³¼í•™ ê³„ì‚°
        numpy\<2.0 \
        scipy \
        scikit-learn \
        # ë°ì´í„° ì²˜ë¦¬
        h5py \
        pandas \
        # ìœ í‹¸ë¦¬í‹°
        tqdm>=4.65.0 \
        omegaconf>=2.3.0 \
        pyyaml>=6.0 \
        # ì˜¤ë””ì˜¤ ì²˜ë¦¬
        librosa \
        soundfile \
        # ë¡œê¹…/ëª¨ë‹ˆí„°ë§
        wandb \
        tensorboard \
        # ROS2 Python ì§€ì›
        rclpy

# 9ï¸âƒ£ Mobile VLA ì „ìš© Python íŒ¨í‚¤ì§€
RUN pip3 install --no-cache-dir \
        # í‚¤ë³´ë“œ ì…ë ¥ ì²˜ë¦¬
        keyboard \
        # ì‹œë¦¬ì–¼ í†µì‹  (ë¡œë´‡ ì œì–´ìš©)
        pyserial \
        # ë„¤íŠ¸ì›Œí‚¹
        requests \
        # ë‚ ì§œ/ì‹œê°„ ì²˜ë¦¬
        python-dateutil

# ğŸ”Ÿ Poetry ì„¤ì¹˜ (RoboVLMs í˜¸í™˜ì„±)
RUN curl -sSL https://install.python-poetry.org | python3 - \
    && ln -s /root/.local/bin/poetry /usr/local/bin/poetry

# 1ï¸âƒ£1ï¸âƒ£ ì‘ì—…ê³µê°„ ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /workspace/vla \
    && mkdir -p /workspace/vla/ROS_action \
    && mkdir -p /workspace/vla/mobile_vla_dataset \
    && mkdir -p /workspace/vla/.cache/huggingface \
    && mkdir -p /workspace/vla/logs

# 1ï¸âƒ£2ï¸âƒ£ .bashrc ì„¤ì • (ROS2 ìë™ ì†Œì‹± + ìœ ìš©í•œ alias)
RUN echo '' >> /root/.bashrc && \
    echo '# ==============================================================================' >> /root/.bashrc && \
    echo '# ğŸš€ Mobile VLA Docker í™˜ê²½ ì„¤ì •' >> /root/.bashrc && \
    echo '# ==============================================================================' >> /root/.bashrc && \
    echo '' >> /root/.bashrc && \
    echo '# ROS2 Humble í™˜ê²½ ìë™ ì†Œì‹±' >> /root/.bashrc && \
    echo 'source /opt/ros/humble/setup.bash' >> /root/.bashrc && \
    echo 'export ROS_DOMAIN_ID=42' >> /root/.bashrc && \
    echo 'export ROS_LOCALHOST_ONLY=0' >> /root/.bashrc && \
    echo '' >> /root/.bashrc && \
    echo '# ROS_action ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìë™ ì†Œì‹± (ì¡´ì¬í•  ê²½ìš°)' >> /root/.bashrc && \
    echo 'if [ -f "/workspace/vla/ROS_action/install/setup.bash" ]; then' >> /root/.bashrc && \
    echo '    source /workspace/vla/ROS_action/install/setup.bash' >> /root/.bashrc && \
    echo 'fi' >> /root/.bashrc && \
    echo '' >> /root/.bashrc && \
    echo '# CUDA í™˜ê²½ í™•ì¸' >> /root/.bashrc && \
    echo 'export CUDA_VISIBLE_DEVICES=0' >> /root/.bashrc && \
    echo '' >> /root/.bashrc && \
    echo '# ìœ ìš©í•œ alias' >> /root/.bashrc && \
    echo 'alias ll="ls -alF"' >> /root/.bashrc && \
    echo 'alias la="ls -A"' >> /root/.bashrc && \
    echo 'alias l="ls -CF"' >> /root/.bashrc && \
    echo 'alias ..="cd .."' >> /root/.bashrc && \
    echo 'alias grep="grep --color=auto"' >> /root/.bashrc && \
    echo '' >> /root/.bashrc && \
    echo '# Mobile VLA ì „ìš© alias' >> /root/.bashrc && \
    echo 'alias vla-build="cd /workspace/vla/ROS_action && colcon build"' >> /root/.bashrc && \
    echo 'alias vla-source="source /workspace/vla/ROS_action/install/setup.bash"' >> /root/.bashrc && \
    echo 'alias vla-camera="ros2 run camera_pub camera_publisher_continuous"' >> /root/.bashrc && \
    echo 'alias vla-collect="cd /workspace/vla && python mobile_vla_data_collector.py"' >> /root/.bashrc && \
    echo 'alias cuda-test="python -c \"import torch; print(f\\\"PyTorch: {torch.__version__}\\\"); print(f\\\"CUDA Available: {torch.cuda.is_available()}\\\"); print(f\\\"CUDA Device: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else \\\"N/A\\\"}\\\")\"' >> /root/.bashrc && \
    echo '' >> /root/.bashrc && \
    echo '# í™˜ì˜ ë©”ì‹œì§€' >> /root/.bashrc && \
    echo 'echo "ğŸš€ Mobile VLA Docker í™˜ê²½ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!"' >> /root/.bashrc && \
    echo 'echo "ğŸ“‹ ìœ ìš©í•œ ëª…ë ¹ì–´:"' >> /root/.bashrc && \
    echo 'echo "   vla-build    : ROS2 ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë¹Œë“œ"' >> /root/.bashrc && \
    echo 'echo "   vla-source   : ROS2 í™˜ê²½ ì†Œì‹±"' >> /root/.bashrc && \
    echo 'echo "   vla-camera   : CSI ì¹´ë©”ë¼ ë…¸ë“œ ì‹¤í–‰"' >> /root/.bashrc && \
    echo 'echo "   vla-collect  : Mobile VLA ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘"' >> /root/.bashrc && \
    echo 'echo "   cuda-test    : CUDA/PyTorch ìƒíƒœ í™•ì¸"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc

# 1ï¸âƒ£3ï¸âƒ£ í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN echo '#!/bin/bash' > /usr/local/bin/healthcheck.sh && \
    echo 'echo "ğŸ” Mobile VLA Docker í™˜ê²½ ìƒíƒœ í™•ì¸..."' >> /usr/local/bin/healthcheck.sh && \
    echo 'python3 -c "import torch; print(f\"âœ… PyTorch {torch.__version__} - CUDA: {torch.cuda.is_available()}\")"' >> /usr/local/bin/healthcheck.sh && \
    echo 'python3 -c "import cv2; print(f\"âœ… OpenCV {cv2.__version__}\")"' >> /usr/local/bin/healthcheck.sh && \
    echo 'python3 -c "import transformers; print(f\"âœ… Transformers {transformers.__version__}\")"' >> /usr/local/bin/healthcheck.sh && \
    echo 'source /opt/ros/humble/setup.bash && echo "âœ… ROS2 Humble ì¤€ë¹„ ì™„ë£Œ"' >> /usr/local/bin/healthcheck.sh && \
    echo 'echo "ğŸ‰ ëª¨ë“  ì‹œìŠ¤í…œ ì •ìƒ!"' >> /usr/local/bin/healthcheck.sh && \
    chmod +x /usr/local/bin/healthcheck.sh

# 1ï¸âƒ£4ï¸âƒ£ ì»¨í…Œì´ë„ˆ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸
RUN echo '#!/bin/bash' > /usr/local/bin/start-mobile-vla.sh && \
    echo 'set -e' >> /usr/local/bin/start-mobile-vla.sh && \
    echo 'echo "ğŸš€ Mobile VLA Docker í™˜ê²½ ì‹œì‘ ì¤‘..."' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '# ROS2 í™˜ê²½ ì„¤ì •' >> /usr/local/bin/start-mobile-vla.sh && \
    echo 'source /opt/ros/humble/setup.bash' >> /usr/local/bin/start-mobile-vla.sh && \
    echo 'export ROS_DOMAIN_ID=42' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '# ROS_action ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë¹Œë“œ (ì²˜ìŒ í•œ ë²ˆë§Œ)' >> /usr/local/bin/start-mobile-vla.sh && \
    echo 'if [ -d "/workspace/vla/ROS_action/src" ] && [ ! -d "/workspace/vla/ROS_action/install" ]; then' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '    echo "ğŸ“¦ ROS_action ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë¹Œë“œ ì¤‘..."' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '    cd /workspace/vla/ROS_action' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '    colcon build --packages-select camera_pub' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '    source install/setup.bash' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '    echo "âœ… ROS_action ë¹Œë“œ ì™„ë£Œ"' >> /usr/local/bin/start-mobile-vla.sh && \
    echo 'fi' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '# í—¬ìŠ¤ì²´í¬ ì‹¤í–‰' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '/usr/local/bin/healthcheck.sh' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '' >> /usr/local/bin/start-mobile-vla.sh && \
    echo '# ë¬´í•œ ëŒ€ê¸° (ì»¨í…Œì´ë„ˆ ìœ ì§€)' >> /usr/local/bin/start-mobile-vla.sh && \
    echo 'echo "ğŸ’¤ ì»¨í…Œì´ë„ˆ ì¤€ë¹„ ì™„ë£Œ. ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ ì ‘ì†í•˜ì„¸ìš”."' >> /usr/local/bin/start-mobile-vla.sh && \
    echo 'tail -f /dev/null' >> /usr/local/bin/start-mobile-vla.sh && \
    chmod +x /usr/local/bin/start-mobile-vla.sh

# 1ï¸âƒ£5ï¸âƒ£ ë³¼ë¥¨ ë§ˆìš´íŠ¸ í¬ì¸íŠ¸ ìƒì„±
VOLUME ["/workspace/vla", "/workspace/vla/.cache"]

# 1ï¸âƒ£6ï¸âƒ£ í¬íŠ¸ ë…¸ì¶œ (ë””ë²„ê¹…/ëª¨ë‹ˆí„°ë§ìš©)
EXPOSE 8888 6006

# 1ï¸âƒ£7ï¸âƒ£ í—¬ìŠ¤ì²´í¬ ì„¤ì •
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD /usr/local/bin/healthcheck.sh

# 1ï¸âƒ£8ï¸âƒ£ ê¸°ë³¸ ì‹¤í–‰ ëª…ë ¹ì–´
CMD ["/usr/local/bin/start-mobile-vla.sh"]