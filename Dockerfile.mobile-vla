# =============================================================================
# ğŸš€ Mobile VLA Docker í™˜ê²½ - Python 3.10 + PyTorch 2.3.0 wheel íŒŒì¼ ê¸°ë°˜
# í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œê³¼ ì •í™•íˆ ë§¤ì¹­ë˜ëŠ” ë²„ì „ìœ¼ë¡œ êµ¬ì„±
# =============================================================================

# ë² ì´ìŠ¤ ì´ë¯¸ì§€: Ubuntu 22.04 (Jetson í˜¸í™˜)
FROM ubuntu:22.04

# NVIDIA CUDA ë° cuDNN ì„¤ì¹˜ë¥¼ ìœ„í•œ ì €ì¥ì†Œ ì¶”ê°€
ENV DEBIAN_FRONTEND=noninteractive

# ë©”íƒ€ë°ì´í„°
LABEL maintainer="Mobile VLA Team"
LABEL description="Mobile VLA System with CSI Camera & ROS2 Humble - Based on Verified VLA Environment"
LABEL version="1.0-mobile-vla"
LABEL base="vla_app_final_restored"

# ì‚¬ìš©ì ì„¤ì •
USER root

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ê¸°ì¡´ vla_app_finalê³¼ ë™ì¼)
ENV DEBIAN_FRONTEND=noninteractive
ENV LANGUAGE=en_US:en
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV CUDA_HOME=/usr/local/cuda
ENV NVCC_PATH=/usr/local/cuda/bin/nvcc
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=all
ENV CUDAARCHS=87
ENV CUDA_ARCHITECTURES=87
ENV PATH="/root/.local/bin:/root/.cargo/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
ENV PYTHONUNBUFFERED=1
ENV RMW_IMPLEMENTATION=rmw_cyclonedx_cpp
ENV HF_HOME=/root/.cache/huggingface

# Jetson ì „ìš© í™˜ê²½ ì„¤ì • (ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ PyPI ê¸°ë³¸ ì„œë²„ ì‚¬ìš©)
# ENV TAR_INDEX_URL=http://jetson.webredirect.org:8000/jp6/cu122
# ENV PIP_INDEX_URL=http://jetson.webredirect.org/jp6/cu122
# ENV PIP_TRUSTED_HOST=jetson.webredirect.org
ENV PIP_INDEX_URL=https://pypi.org/simple/
ENV PIP_TRUSTED_HOST=pypi.org

# CUDA í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (í˜¸ìŠ¤íŠ¸ CUDA ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§ˆìš´íŠ¸ìš©)
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=/usr/local/cuda/bin:${PATH}
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/lib/aarch64-linux-gnu:${LD_LIBRARY_PATH}
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=all

# Mobile VLA ì „ìš© í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€
ENV ROS_DOMAIN_ID=42
ENV ROS_LOCALHOST_ONLY=0
ENV MOBILE_VLA_DATA_DIR=/workspace/vla/mobile_vla_dataset
ENV MOBILE_VLA_LOG_LEVEL=INFO

# 1. ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° Python 3.10 ì„¤ì¹˜
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        # Python 3.10 ë° ê°œë°œ í™˜ê²½
        software-properties-common \
        python3.10 \
        python3.10-dev \
        python3.10-distutils \
        python3-pip \
        # ê¸°ë³¸ ê°œë°œ ë„êµ¬
        build-essential cmake pkg-config \
        curl wget git vim nano htop tree \
        # CUDA ë¼ì´ë¸ŒëŸ¬ë¦¬ (í˜¸ìŠ¤íŠ¸ì—ì„œ ë§ˆìš´íŠ¸ ì˜ˆì •)
        # cuda-toolkit-12-2 \
        # libcudnn8 \
        # libcudnn8-dev \
        # í•„ìˆ˜ ì‹œìŠ¤í…œ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì‹¤ì œ ì‚¬ìš©ë˜ëŠ” ê²ƒë§Œ)
        libhdf5-serial-dev \
        libjpeg-dev libpng-dev \
        libgl1-mesa-glx libglib2.0-0 \
        libopenblas0 \
        # GStreamer (CSI ì¹´ë©”ë¼ìš© - í•„ìˆ˜ë§Œ)
        libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
        gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
        # ê¸°ë³¸ ë„¤íŠ¸ì›Œí‚¹
        curl wget \
    && rm -rf /var/lib/apt/lists/* && \
    apt-get clean

# 2. Python 3.10ì„ ê¸°ë³¸ python3ë¡œ ì„¤ì •
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1 && \
    update-alternatives --install /usr/bin/python python /usr/bin/python3.10 1

# 3. pip ì—…ê·¸ë ˆì´ë“œ ë° í•„ìˆ˜ Python ë„êµ¬ ì„¤ì¹˜
RUN python3 -m pip install --upgrade pip setuptools wheel

# 4. PyTorch wheel íŒŒì¼ë“¤ì„ ì»¨í…Œì´ë„ˆë¡œ ë³µì‚¬
COPY torch-2.3.0-cp310-cp310-linux_aarch64.whl /tmp/
COPY torchaudio-2.3.0+952ea74-cp310-cp310-linux_aarch64.whl /tmp/
COPY torchvision-0.18.0a0+6043bc2-cp310-cp310-linux_aarch64.whl /tmp/

# 5. ë¡œì»¬ wheel íŒŒì¼ì—ì„œ PyTorch ì„¤ì¹˜ (ì •í™•í•œ ë²„ì „ ë§¤ì¹­)
RUN python3 -m pip install --no-cache-dir \
        /tmp/torch-2.3.0-cp310-cp310-linux_aarch64.whl \
        /tmp/torchaudio-2.3.0+952ea74-cp310-cp310-linux_aarch64.whl \
        /tmp/torchvision-0.18.0a0+6043bc2-cp310-cp310-linux_aarch64.whl \
    && rm -f /tmp/*.whl \
    && rm -rf /root/.cache/pip

# 6. ROS2 Humble ì„¤ì¹˜
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        # ROS2 Humble í•„ìˆ˜ íŒ¨í‚¤ì§€
        software-properties-common \
        curl \
        gnupg \
        lsb-release \
    && curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
        ros-humble-desktop \
        python3-colcon-common-extensions \
        python3-rosdep \
        python3-rosinstall-generator \
        python3-wstool \
        python3-rosinstall \
        build-essential \
        cmake \
        git \
        python3-pip \
        python3-argcomplete \
        python3-flake8 \
        python3-flake8-docstrings \
        python3-pytest-cov \
        python3-setuptools \
        python3-vcstool \
        wget \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# 7. ROS2 í™˜ê²½ ì„¤ì •
RUN echo "source /opt/ros/humble/setup.bash" >> /root/.bashrc \
    && rosdep init \
    && rosdep update
        /tmp/torchaudio-2.3.0+952ea74-cp310-cp310-linux_aarch64.whl \
        /tmp/torchvision-0.18.0a0+6043bc2-cp310-cp310-linux_aarch64.whl \
    && rm -f /tmp/*.whl \
    && rm -rf /root/.cache/pip

# 6. í•„ìˆ˜ Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ì‹¤ì œ ì‚¬ìš©ë˜ëŠ” ê²ƒë§Œ)
RUN python3 -m pip install --no-cache-dir \
        # VLA ëª¨ë¸ìš©
        "transformers==4.46.3" \
        "tokenizers==0.20.3" \
        accelerate \
        # ì´ë¯¸ì§€ ì²˜ë¦¬
        Pillow \
        opencv-python \
        # ë°ì´í„° ì²˜ë¦¬
        numpy==1.24.3 \
        h5py==3.8.0 \
        # ê¸°ë³¸ ìœ í‹¸ë¦¬í‹°
        requests \
    && rm -rf /root/.cache/pip

# 7. ROS2 Humble ì„¤ì¹˜ (í•„ìˆ˜ íŒ¨í‚¤ì§€ë§Œ)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        # ROS2 Humble í•„ìˆ˜ íŒ¨í‚¤ì§€
        software-properties-common \
        curl \
        gnupg2 \
        lsb-release \
    && curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
        # ROS2 Humble Desktop (GUI í¬í•¨)
        ros-humble-desktop \
        # ROS2 ê°œë°œ ë„êµ¬
        ros-dev-tools \
        python3-colcon-common-extensions \
        python3-rosdep \
        python3-argcomplete \
        # ROS2 Python íŒ¨í‚¤ì§€
        python3-rosinstall-generator \
        python3-wstool \
        python3-rosinstall \
        # í•„ìˆ˜ ROS2 íŒ¨í‚¤ì§€ë“¤
        ros-humble-rviz2 \
        ros-humble-tf2-tools \
        ros-humble-xacro \
        ros-humble-urdf \
        ros-humble-robot-state-publisher \
        ros-humble-joint-state-publisher \
        ros-humble-joint-state-publisher-gui \
        ros-humble-controller-manager \
        ros-humble-ros2-control \
        ros-humble-ros2-controllers \
        # ì¹´ë©”ë¼ ê´€ë ¨ íŒ¨í‚¤ì§€
        ros-humble-cv-bridge \
        ros-humble-image-transport \
        ros-humble-image-transport-plugins \
        ros-humble-camera-calibration \
        ros-humble-camera-info-manager \
        # ë¡œë´‡ ì œì–´ ê´€ë ¨ íŒ¨í‚¤ì§€
        ros-humble-teleop-twist-keyboard \
        ros-humble-teleop-twist-joy \
        ros-humble-joy \
        ros-humble-joy-linux \
        # ê¸°ë³¸ ë„¤ë¹„ê²Œì´ì…˜ íŒ¨í‚¤ì§€
        ros-humble-nav2-bringup \
        ros-humble-nav2-core \
        ros-humble-nav2-msgs \
        ros-humble-nav2-util \
        ros-humble-nav2-behavior-tree \
        ros-humble-nav2-bt-navigator \
        ros-humble-nav2-controller \
        ros-humble-nav2-costmap-2d \
        ros-humble-nav2-lifecycle-manager \
        ros-humble-nav2-map-server \
        ros-humble-nav2-navfn-planner \
        ros-humble-nav2-planner \
        ros-humble-nav2-regulated-pure-pursuit-controller \
        ros-humble-nav2-rotation-shim-controller \
        ros-humble-nav2-rviz-plugins \
        ros-humble-nav2-simple-commander \
        ros-humble-nav2-smac-planner \
        ros-humble-nav2-theta-star-planner \
        ros-humble-nav2-velocity-smoother \
        ros-humble-nav2-waypoint-follower \
        # ì‹œìŠ¤í…œ ë„êµ¬
        locales \
        locales-all \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# 8. ROS2 í™˜ê²½ ì„¤ì •
RUN echo "source /opt/ros/humble/setup.bash" >> /root/.bashrc && \
    echo "source /usr/share/colcon_argcomplete/hook/colcon-argcomplete.bash" >> /root/.bashrc && \
    echo "export ROS_DOMAIN_ID=42" >> /root/.bashrc && \
    echo "export ROS_LOCALHOST_ONLY=0" >> /root/.bashrc && \
    echo "export RMW_IMPLEMENTATION=rmw_fastrtps_cpp" >> /root/.bashrc && \
    echo "export ROS_DISTRO=humble" >> /root/.bashrc && \
    echo "export LD_LIBRARY_PATH=/opt/ros/humble/lib:\$LD_LIBRARY_PATH" >> /root/.bashrc && \
    echo "export PYTHONPATH=/opt/ros/humble/lib/python3.10/site-packages:\$PYTHONPATH" >> /root/.bashrc && \
    echo "export ROS_VERSION=2" >> /root/.bashrc && \
    echo "export ROS_PYTHON_VERSION=3" >> /root/.bashrc

# 9. ROS2 ì˜ì¡´ì„± ì´ˆê¸°í™”
RUN rosdep init && \
    rosdep update

# 10. ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ë“¤ ë³µì‚¬
COPY pytorch_cuda_test.py /usr/local/bin/pytorch_cuda_test.py
COPY scripts/run_mobile_vla.sh /usr/local/bin/run_mobile_vla.sh
COPY scripts/container_run.sh /usr/local/bin/container_run.sh
RUN chmod +x /usr/local/bin/pytorch_cuda_test.py /usr/local/bin/run_mobile_vla.sh /usr/local/bin/container_run.sh

# 11. ì‘ì—…ê³µê°„ ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /workspace/vla \
    && mkdir -p /workspace/vla/ROS_action \
    && mkdir -p /workspace/vla/mobile_vla_dataset \
    && mkdir -p /workspace/vla/.cache/huggingface \
    && mkdir -p /workspace/vla/logs

# 12. .bashrc ì„¤ì • (PyTorch 2.3.0 í…ŒìŠ¤íŠ¸ìš©)
RUN echo "" >> /root/.bashrc && \
    echo "# =============================================================================" >> /root/.bashrc && \
    echo "# ğŸš€ Mobile VLA + PyTorch 2.3.0 Docker í™˜ê²½" >> /root/.bashrc && \
    echo "# =============================================================================" >> /root/.bashrc && \
    echo "" >> /root/.bashrc && \
    echo "# PyTorch & CUDA Test Alias" >> /root/.bashrc && \
    echo "alias torch_cuda_test='python3 /usr/local/bin/pytorch_cuda_test.py'" >> /root/.bashrc && \
    echo "alias cuda-test='python3 -c \"import torch; print(f\\\"PyTorch: {torch.__version__}\\\"); print(f\\\"CUDA Available: {torch.cuda.is_available()}\\\"); print(f\\\"Device Count: {torch.cuda.device_count()}\\\")\"'" >> /root/.bashrc && \
    echo "" >> /root/.bashrc && \
    echo "# Mobile VLA í…ŒìŠ¤íŠ¸ Alias" >> /root/.bashrc && \
    echo "alias mobile-vla-test='cd /workspace/vla && python3 kosmos_camera_test.py'" >> /root/.bashrc && \
    echo "alias run-mobile-vla='/usr/local/bin/run_mobile_vla.sh'" >> /root/.bashrc && \
    echo "alias container-run='/usr/local/bin/container_run.sh'" >> /root/.bashrc && \
    echo "" >> /root/.bashrc && \
    echo "# í™˜ì˜ ë©”ì‹œì§€" >> /root/.bashrc && \
    echo "echo \"ğŸš€ Mobile VLA + PyTorch 2.3.0 Docker í™˜ê²½\"" >> /root/.bashrc && \
    echo "echo \"ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:\"" >> /root/.bashrc && \
    echo "echo \"   cuda-test       : PyTorch/CUDA ìƒíƒœ í™•ì¸\"" >> /root/.bashrc && \
    echo "echo \"   mobile-vla-test : Mobile VLA ì¹´ë©”ë¼ í…ŒìŠ¤íŠ¸\"" >> /root/.bashrc && \
    echo "echo \"   torch_cuda_test : ìƒì„¸ PyTorch CUDA í…ŒìŠ¤íŠ¸\"" >> /root/.bashrc && \
    echo "echo \"   run-mobile-vla  : Mobile VLA ì‹œìŠ¤í…œ ì‹¤í–‰\"" >> /root/.bashrc && \
    echo "echo \"   container-run   : ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì‹¤í–‰ ë©”ë‰´\"" >> /root/.bashrc && \
    echo "echo \"\"" >> /root/.bashrc

# 13. í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN echo '#!/bin/bash' > /usr/local/bin/healthcheck.sh && \
    echo 'echo "ğŸ” Mobile VLA + PyTorch 2.3.0 Docker í™˜ê²½ ìƒíƒœ í™•ì¸..."' >> /usr/local/bin/healthcheck.sh && \
    echo 'python3 -c "import torch; print(f\"âœ… PyTorch {torch.__version__} - CUDA: {torch.cuda.is_available()}\")"' >> /usr/local/bin/healthcheck.sh && \
    echo 'python3 -c "import cv2; print(f\"âœ… OpenCV {cv2.__version__}\")" 2>/dev/null || echo "âš ï¸ OpenCV check skipped"' >> /usr/local/bin/healthcheck.sh && \
    echo 'python3 -c "import transformers; print(f\"âœ… Transformers {transformers.__version__}\")"' >> /usr/local/bin/healthcheck.sh && \
    echo 'python3 -c "import h5py; print(f\"âœ… HDF5 {h5py.__version__}\")"' >> /usr/local/bin/healthcheck.sh && \
    echo 'python3 -c "from PIL import Image; print(\"âœ… Pillow OK\")"' >> /usr/local/bin/healthcheck.sh && \
    echo 'echo "ğŸ‰ PyTorch 2.3.0 í™˜ê²½ ì •ìƒ - Mobile VLA í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ!"' >> /usr/local/bin/healthcheck.sh && \
    chmod +x /usr/local/bin/healthcheck.sh

# 14. ë³¼ë¥¨ ë§ˆìš´íŠ¸ í¬ì¸íŠ¸ ìƒì„±
VOLUME ["/workspace/vla", "/workspace/vla/.cache"]

# 15. í¬íŠ¸ ë…¸ì¶œ (ë””ë²„ê¹…/ëª¨ë‹ˆí„°ë§ìš©)
EXPOSE 8888 6006

# 16. í—¬ìŠ¤ì²´í¬ ì„¤ì •
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD /usr/local/bin/healthcheck.sh

# 17. ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /workspace/vla

# 18. ê¸°ë³¸ ëª…ë ¹ì–´
CMD ["bash"]

# =============================================================================
# ë¹Œë“œ ëª…ë ¹ì–´:
# docker build -t mobile_vla:pytorch-2.3.0 -f Dockerfile.mobile-vla .
# 
# ì‹¤í–‰ ëª…ë ¹ì–´:
# docker run --rm --gpus all -it mobile_vla:pytorch-2.3.0
# =============================================================================