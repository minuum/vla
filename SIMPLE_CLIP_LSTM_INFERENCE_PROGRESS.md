# Simple CLIP LSTM λ¨λΈ μ²΄ν¬ν¬μΈνΈ κΈ°λ° μ¶”λ΅  μ‹μ¤ν… κ°λ° μ§„ν–‰μƒν™©

## π“‹ ν”„λ΅μ νΈ κ°μ”

**λ©ν‘**: `best_simple_clip_lstm_model.pth` μ²΄ν¬ν¬μΈνΈλ¥Ό κΈ°λ°μΌλ΅ λ„μ»¤ ν™κ²½μ—μ„ μ¶”λ΅  μ‹μ¤ν… κµ¬μ¶•

**μ²΄ν¬ν¬μΈνΈ μ„μΉ**: `vla/Robo+/Mobile_VLA/simple_clip_lstm_model/best_simple_clip_lstm_model.pth` (7.3GB)

## π” λ¨λΈ κµ¬μ΅° λ¶„μ„ κ²°κ³Ό

### μ‹¤μ  λ¨λΈ κµ¬μ΅° (μ²΄ν¬ν¬μΈνΈ ν‚¤ λ¶„μ„)
- **Kosmos2 + CLIP ν•μ΄λΈλ¦¬λ“ λ¨λΈ**
- **Kosmos2 Text Model**: 24μΈµ Transformer (4096μ°¨μ›)
- **Kosmos2 Vision Model**: 24μΈµ ViT (4096μ°¨μ›)
- **CLIP Text Model**: 12μΈµ Transformer (768μ°¨μ›)
- **CLIP Vision Model**: 12μΈµ ViT (768μ°¨μ›)
- **Feature Fusion Layer**: 4864 β†’ 2048
- **LSTM Layer**: 4μΈµ (512μ°¨μ›)
- **Action Head**: 2μ°¨μ› μ¶λ ¥ (λ΅λ΄‡ μ μ–΄)

### μ²΄ν¬ν¬μΈνΈ ν‚¤ κµ¬μ΅°
```
kosmos_model.text_model.model.layers.0-23.*
kosmos_model.vision_model.model.encoder.layers.0-23.*
clip_model.text_model.encoder.layers.0-11.*
clip_model.vision_model.encoder.layers.0-11.*
feature_fusion.weight/bias
rnn.weight_ih_l0-3, rnn.weight_hh_l0-3
actions.mlp.0-8.weight/bias
```

## π€ κ°λ°λ μ‹μ¤ν… κµ¬μ„±

### 1. λ©”μΈ μ¶”λ΅  μ¤ν¬λ¦½νΈ
- **`vla/run_simple_clip_lstm_inference.sh`**: λ„μ»¤ μ»¨ν…μ΄λ„ μ‹¤ν–‰ λ° μ¶”λ΅  μ‹μ‘
- **`vla/kosmos_clip_hybrid_inference.py`**: Kosmos2 + CLIP ν•μ΄λΈλ¦¬λ“ λ¨λΈ μ¶”λ΅ 
- **`vla/memory_optimized_inference.py`**: λ©”λ¨λ¦¬ μµμ ν™”λ μ¶”λ΅  (λ©”λ¨λ¦¬ λ¨λ‹ν„°λ§ ν¬ν•¨)

### 2. λ„μ»¤ ν™κ²½ μ„¤μ •
- **λ² μ΄μ¤ μ΄λ―Έμ§€**: `mobile_vla:pytorch-2.3.0-cuda`
- **GPU μ§€μ›**: Jetson Orin NX (CUDA μ§€μ›)
- **λ³Όλ¥¨ λ§μ΄νΈ**: μ²΄ν¬ν¬μΈνΈ νμΌ μ ‘κ·Ό

## β οΈ λ°μƒν• λ¬Έμ μ λ“¤

### 1. λ©”λ¨λ¦¬ λ¶€μ΅± λ¬Έμ 
- **μ¦μƒ**: λ¨λΈ λ΅λ“ μ‹ "Killed" μ¤λ¥
- **μ›μΈ**: 7.3GB μ²΄ν¬ν¬μΈνΈ + λ€κ·λ¨ λ¨λΈ κµ¬μ΅°
- **ν•΄κ²°μ±…**: λ©”λ¨λ¦¬ μµμ ν™”λ λ¨λΈ κµ¬μ΅° κµ¬ν„

### 2. λ¨λΈ κµ¬μ΅° λ¶μΌμΉ
- **μ¦μƒ**: `RuntimeError: Missing key(s) in state_dict`
- **μ›μΈ**: μμƒ λ¨λΈ κµ¬μ΅°μ™€ μ‹¤μ  μ²΄ν¬ν¬μΈνΈ κµ¬μ΅° λ¶μΌμΉ
- **ν•΄κ²°μ±…**: μ‹¤μ  μ²΄ν¬ν¬μΈνΈ ν‚¤ κµ¬μ΅°μ— λ§λ” λ¨λΈ μ •μ

### 3. μ»¨ν…μ΄λ„ μ‹¤ν–‰ λ¬Έμ 
- **μ¦μƒ**: μ»¨ν…μ΄λ„ μΆ…λ£ λ° μ¬μ‹μ‘ ν•„μ”
- **μ›μΈ**: λ©”λ¨λ¦¬ λ¶€μ΅±μΌλ΅ μΈν• ν”„λ΅μ„Έμ¤ μΆ…λ£
- **ν•΄κ²°μ±…**: λ©”λ¨λ¦¬ λ¨λ‹ν„°λ§ λ° μµμ ν™”

## π”§ κµ¬ν„λ ν•΄κ²°μ±…

### 1. λ©”λ¨λ¦¬ μµμ ν™”
```python
# λ©”λ¨λ¦¬ λ¨λ‹ν„°λ§
def get_memory_info():
    # μ‹μ¤ν… λ©”λ¨λ¦¬ + GPU λ©”λ¨λ¦¬ μ •λ³΄

# λ©”λ¨λ¦¬ μ •λ¦¬
def clear_memory():
    torch.cuda.empty_cache()
    gc.collect()

# λ¨λΈ μµμ ν™”
- λ μ΄μ–΄ μ μ¤„μ„ (24β†’6, 12β†’6)
- μ…λ ¥ ν¬κΈ° μµμ ν™”
- μ¤‘κ°„ ν…μ„ λ©”λ¨λ¦¬ ν•΄μ 
```

### 2. λ¨λΈ κµ¬μ΅° μμ •
```python
class MemoryOptimizedKosmosCLIPModel(nn.Module):
    # Kosmos2 λ¨λΈ (6μΈµμΌλ΅ μ¶•μ†)
    # CLIP λ¨λΈ (6μΈµμΌλ΅ μ¶•μ†)
    # LSTM (2μΈµμΌλ΅ μ¶•μ†)
    # λ©”λ¨λ¦¬ ν¨μ¨μ μΈ forward pass
```

### 3. λ€ν™”ν• μ¶”λ΅  μ‹μ¤ν…
```python
# μ‚¬μ© κ°€λ¥ν• λ…λ Ήμ–΄
- 'infer': λ‹¨μΌ μ¶”λ΅  μ‹¤ν–‰
- 'benchmark': μ„±λ¥ λ²¤μΉλ§ν¬
- 'memory': λ©”λ¨λ¦¬ μƒνƒ ν™•μΈ
- 'clear': λ©”λ¨λ¦¬ μ •λ¦¬
- 'quit': μΆ…λ£
```

## π“ ν„μ¬ μƒνƒ

### β… μ™„λ£λ μ‘μ—…
1. μ²΄ν¬ν¬μΈνΈ κµ¬μ΅° λ¶„μ„
2. λ©”λ¨λ¦¬ μµμ ν™”λ λ¨λΈ κµ¬ν„
3. λ„μ»¤ μ»¨ν…μ΄λ„ μ‹¤ν–‰ μ¤ν¬λ¦½νΈ
4. λ©”λ¨λ¦¬ λ¨λ‹ν„°λ§ μ‹μ¤ν…
5. λ€ν™”ν• μ¶”λ΅  μΈν„°νμ΄μ¤

### β οΈ ν„μ¬ λ¬Έμ μ 
1. λ¨λΈ κ°€μ¤‘μΉ λ΅λ“ μ‹ κµ¬μ΅° λ¶μΌμΉ
2. λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ΄ μ—¬μ „ν λ†’μ
3. μ‹¤μ  μ¶”λ΅  μ„±λ¥ ν…μ¤νΈ λ―Έμ™„λ£

### π”„ λ‹¤μ λ‹¨κ³„
1. μ‹¤μ  μ²΄ν¬ν¬μΈνΈ κµ¬μ΅°μ— λ§λ” λ¨λΈ μμ •
2. λ©”λ¨λ¦¬ μ‚¬μ©λ‰ μ¶”κ°€ μµμ ν™”
3. μ‹¤μ  μ¶”λ΅  μ„±λ¥ ν…μ¤νΈ
4. λ΅λ΄‡ μ μ–΄ μ—°λ™

## π― μ„±λ¥ λ©ν‘

### μμƒ μ„±λ¥
- **λ¨λΈ ν¬κΈ°**: λ€κ·λ¨ ν•μ΄λΈλ¦¬λ“ (Kosmos2 + CLIP)
- **μ…λ ¥**: Vision patches + Text tokens
- **μ¶λ ¥**: 2D λ΅λ΄‡ μ•΅μ… (μ„ ν•/κ°μ†λ„)
- **λ©ν‘ FPS**: Jetson Orin NXμ—μ„ μ‹¤μ‹κ°„ μ¶”λ΅ 

### λ©”λ¨λ¦¬ μ”κµ¬μ‚¬ν•­
- **μ²΄ν¬ν¬μΈνΈ**: 7.3GB
- **λ¨λΈ λ΅λ“**: ~8-10GB
- **μ¶”λ΅  μ‹**: ~2-4GB
- **μ΄ ν•„μ”**: ~12-15GB

## π“ μ‹¤ν–‰ λ°©λ²•

### 1. μ¶”λ΅  μ»¨ν…μ΄λ„ μ‹μ‘
```bash
cd /home/soda
./vla/run_simple_clip_lstm_inference.sh
```

### 2. λ©”λ¨λ¦¬ μµμ ν™”λ μ¶”λ΅  μ‹¤ν–‰
```bash
python3 vla/memory_optimized_inference.py
```

### 3. λ©”λ¨λ¦¬ μƒνƒ ν™•μΈ
```bash
# μ»¨ν…μ΄λ„ λ‚΄λ¶€μ—μ„
python3 -c "import psutil; print(psutil.virtual_memory())"
nvidia-smi
```

## π” λ””λ²„κΉ… μ •λ³΄

### μ²΄ν¬ν¬μΈνΈ λ¶„μ„
- **νμΌ ν¬κΈ°**: 7.3GB
- **ν‚¤ μ**: 1000+ κ°
- **μ£Όμ” κµ¬μ„±**: Kosmos2 + CLIP + LSTM + Action Head

### λ©”λ¨λ¦¬ μ‚¬μ©λ‰
- **μ‹μ¤ν… λ©”λ¨λ¦¬**: 16GB (Jetson Orin NX)
- **GPU λ©”λ¨λ¦¬**: 8GB
- **ν„μ¬ μ‚¬μ©λ‰**: λ¨λΈ λ΅λ“ μ‹ 90%+ μ‚¬μ©

### μ¤λ¥ λ΅κ·Έ
```
RuntimeError: Error(s) in loading state_dict for SimpleCLIPLSTMModel:
Missing key(s) in state_dict: "vision_encoder.weight", ...
Unexpected key(s) in state_dict: "kosmos_model.text_model.model.embed_tokens.weight", ...
```

## π“ ν–¥ν›„ κ³„ν

### λ‹¨κΈ° λ©ν‘ (1-2μ£Ό)
1. λ¨λΈ κµ¬μ΅° μ™„μ „ μμ •
2. λ©”λ¨λ¦¬ μµμ ν™” μ™„λ£
3. κΈ°λ³Έ μ¶”λ΅  μ„±λ¥ ν™•μΈ

### μ¤‘κΈ° λ©ν‘ (1κ°μ›”)
1. μ‹¤μ‹κ°„ μ¶”λ΅  μ„±λ¥ λ‹¬μ„±
2. λ΅λ΄‡ μ μ–΄ μ—°λ™
3. μ‹¤μ  ν™κ²½ ν…μ¤νΈ

### μ¥κΈ° λ©ν‘ (3κ°μ›”)
1. μ„±λ¥ μµμ ν™” μ™„λ£
2. λ°°ν¬ μ‹μ¤ν… κµ¬μ¶•
3. λ¬Έμ„ν™” λ° κ°€μ΄λ“ μ™„μ„±

---

**λ§μ§€λ§‰ μ—…λ°μ΄νΈ**: 2024-08-24
**μƒνƒ**: κ°λ° μ¤‘ (λ©”λ¨λ¦¬ μµμ ν™” λ‹¨κ³„)
**λ‹¤μ λ§μΌμ¤ν†¤**: λ¨λΈ κµ¬μ΅° μμ • λ° μ¶”λ΅  μ„±κ³µ
