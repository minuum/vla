# =============================================================================
# 🚀 Mobile VLA RoboVLMs Docker 환경 - 간단한 테스트 버전
# 기본 기능만 포함하여 안정성 확보
# =============================================================================

# 베이스 이미지: 검증된 Jetson PyTorch
FROM nvcr.io/nvidia/l4t-pytorch:r35.2.1-pth2.0-py3

# 메타데이터
LABEL maintainer="Mobile VLA RoboVLMs Team"
LABEL description="Mobile VLA RoboVLMs System - Simple Test Version"
LABEL version="1.0-simple"

# 사용자 설정
USER root

# 환경 변수 설정
ENV DEBIAN_FRONTEND=noninteractive
ENV LANGUAGE=en_US:en
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV CUDA_HOME=/usr/local/cuda
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=all
ENV PYTHONUNBUFFERED=1

# 1. 기본 시스템 패키지 설치
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl wget git vim nano htop tree \
        build-essential cmake pkg-config \
        python3-pip python3-dev \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# 2. Python 패키지 설치 (최소한만)
RUN pip3 install --no-cache-dir --upgrade pip && \
    pip3 install --no-cache-dir \
        numpy \
        Pillow \
        requests \
    && rm -rf /root/.cache/pip

# 3. PyTorch CUDA 테스트 스크립트 추가
COPY pytorch_cuda_test.py /usr/local/bin/pytorch_cuda_test.py
RUN chmod +x /usr/local/bin/pytorch_cuda_test.py

# 4. 작업공간 디렉토리 생성
RUN mkdir -p /workspace/vla \
    && mkdir -p /workspace/vla/ROS_action \
    && mkdir -p /workspace/vla/mobile_vla_dataset \
    && mkdir -p /workspace/vla/logs \
    && chmod -R 777 /workspace/vla

# 5. .bashrc 설정 (간단한 버전)
RUN echo "" >> /root/.bashrc && \
    echo "# =============================================================================" >> /root/.bashrc && \
    echo "# 🚀 Mobile VLA RoboVLMs Docker 환경 - Simple Test Version" >> /root/.bashrc && \
    echo "# =============================================================================" >> /root/.bashrc && \
    echo "" >> /root/.bashrc && \
    echo "# PyTorch & CUDA Test Alias" >> /root/.bashrc && \
    echo "alias torch_cuda_test='python3 /usr/local/bin/pytorch_cuda_test.py'" >> /root/.bashrc && \
    echo "alias cuda-test='python3 -c \"import torch; print(f\\\"PyTorch: {torch.__version__}\\\"); print(f\\\"CUDA Available: {torch.cuda.is_available()}\\\"); print(f\\\"CUDA Device: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else \\\"N/A\\\"}\\\")\"'" >> /root/.bashrc && \
    echo "" >> /root/.bashrc && \
    echo "# 환영 메시지" >> /root/.bashrc && \
    echo "echo \"🚀 Mobile VLA RoboVLMs Docker 환경 - Simple Test Version\"" >> /root/.bashrc && \
    echo "echo \"📋 사용 가능한 명령어:\"" >> /root/.bashrc && \
    echo "echo \"   cuda-test     : CUDA 테스트\"" >> /root/.bashrc && \
    echo "echo \"   torch_cuda_test: PyTorch CUDA 테스트\"" >> /root/.bashrc && \
    echo "echo \"\"" >> /root/.bashrc && \
    echo "echo \"🎯 현재 환경: PyTorch + CUDA\"" >> /root/.bashrc && \
    echo "echo \"🔧 CUDA: $(python3 -c 'import torch; print(torch.cuda.is_available())' 2>/dev/null || echo 'Unknown')\"" >> /root/.bashrc && \
    echo "echo \"\"" >> /root/.bashrc

# 6. 작업 디렉토리 설정
WORKDIR /workspace/vla

# 7. 기본 명령어 설정
CMD ["/bin/bash"]
